<!--
 * @Author: wjz
 * @Date: 2021-10-19 20:35:58
 * @LastEditors: wjz
 * @LastEditTime: 2021-11-23 11:43:55
 * @FilePath: /kmaps/test/index.html
-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>测试</title>
  <style>
    * {
      margin: 0;
    }

    #KMaps {
      width: 100vw;
      height: 100vh;
      background-color: rgb(218, 238, 255);
    }

    .butt {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <div id="KMaps"></div>
  <div class="butt">
    <button class="loc" type="button">定位拖拽</button>
    <button class="shape" type="button">富信息编辑</button>
  </div>


  <script src="../lib/KMaps.js"></script>
  <script type="module">
    import { bezierData } from './util.js'

    import KMaps from '../src/index.ts'
    import img from './assets/maps.png'
    let width = document.getElementById('KMaps').clientWidth,
      height = document.getElementById('KMaps').clientHeight
    console.log(width, height);
    //创建舞台
    const stage = new KMaps.Stage({
      container: 'KMaps',
      width,
      height,
      // scaleMax:20,
      // scaleMin:0.5
    })
    //创建基础 图层
    let baseLayer = new KMaps.Layer({ id: 'baseLayer' })
    stage.add(baseLayer)

    let baseMap = new KMaps.BaseMap() //创建底图层
    // let path = new KMaps.Path()
    let pathGroup = new KMaps.Group({ id: "pathGroup" })
    let shapeGroup = new KMaps.Group({ id: "shapeGroup" })
    let locationGroup = new KMaps.Group({ id: "locationGroup" }) //定位层
    let grid = new KMaps.Grid({ grid: 60 })// 创建网格层
    let loc = new KMaps.Location()
    locationGroup.add(loc)
    let track = new KMaps.Track()
    baseLayer.add(baseMap, pathGroup, grid, shapeGroup, track, locationGroup)


    //加载图片
    let image = new Image()
    image.onload = async function () {
      await baseMap.image(this) //绘制地图
      // pathGroup.position(baseMap.position()) //重置pathGroup 相对坐标位置
      let image = baseLayer.toDataURL({
        mimeType: "image/png",
        quality: 1,
        pixelRatio: 2
      })
      // this.visible(false)
    }
    image.src = img
    loc.location({ x: 100, y: 1000, angle: 90 })

    // console.log(KMaps,stage);
    document.querySelector(".loc").addEventListener('click', () => {
      let d = loc.draggable()
      loc.draggable(!d)
      console.log(loc.location());
    })
    loc.addEventListener('drag', (e) => {
      console.log(e.detail);
    })
    //获取路径数据
    let url = "http://192.168.1.10:62002/api/map/area/edges?map=613715e5fee0c72a632453cb&map_areas="
    let xhr = new XMLHttpRequest()
    xhr.open("GET", url)
    xhr.send()
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        // 处理响应正文responseText，多数是json数据
        let data = JSON.parse(xhr.responseText).data
        let pathData = bezierData(data)
        pathData.forEach((item) => {
          let path = new KMaps.Path({
            id: item.id,
            points: item.edges,
            stroke: "#0099FF",
            hitEvent: true
          })
          pathGroup.add(path)
          pathGroup.cache({
            pixelRatio: 3 //4倍像素
          })
          path.addEventListener("click touchend", function () {
            if (this.attrs.stroke == "#0099FF") {
              this.stroke("#33bb33")
            } else {
              this.stroke("#0099FF")
            }
            pathGroup.cache({
              pixelRatio: 3 //4倍像素
            })
          })
        });
      }
    }

    //http://192.168.1.10:62002/api/map/area/edges?map=613715e5fee0c72a632453cb&map_areas=

    let Line = new KMaps.Line({
      id: "aaa",
      points: [[100, 200], [500, 500]],
      color:"#fc0a07"
    })
    shapeGroup.add(Line)
    // Line.draggable(true)
    // Line.draggable(false)
    var targetShape = null
    Line.on("click touchend", function (e) {
      console.log(e);
      e.cancelBubble = true;
      // if(!this.draggable()){
      this.draggable(true)
      console.log("11", this.getPoints());

      // }
      targetShape = this

    })
    let polygon = new KMaps.Polygon({
      id: "bbb",
      points: [[200, 200], [500, 200],[500,500],[200,500]],
      color:"#fc0a07"
    })
    shapeGroup.add(polygon)


    polygon.on("click touchend", function (e) {
      e.cancelBubble = true;
      // if(!this.draggable()){
      this.draggable(true)
      console.log(this.getPoints());

      // }
      targetShape = this

    })

    document.querySelector(".shape").addEventListener('click', () => {
      targetShape.draggable(false)
      console.log(targetShape.getPoints() );
      
    })

    stage.on("dragstart dragend", function (e) {
      e.cancelBubble = true;
      if (e.type == "dragend") {
        shapeGroup.visible(true)
      } else {
        shapeGroup.visible(false)
      }
    })
    KMaps.Util.wheelEvent(stage, (e) => {
      if (e.type == "wheelend") {
        shapeGroup.visible(true)
      } else {
        shapeGroup.visible(false)
      }
    })
    

  </script>
</body>

</html>